#!/usr/bin/env python3
import sys
try:
    sys.path.insert(0, './src')
    from SQLite import SQLite as DB
    import Logger, Cmdline, Configuration, OSMDB
    from Help import helpAndExit as helpAndExit
except ImportError as e:
    print(str(e), file=sys.stderr)
    print('Cannot find the module(s) listed above. Exiting.', file=sys.stderr)
    sys.exit(1)

short_options = {'--update'    : '-u',
                 '--network'   : '-n',
                 '--list'      : '-l',
                 '--execute'   : '-e'}
cmdline = Cmdline.Cmdline(sys.argv, short_options)
configuration = Configuration.Configuration()
logger = Logger.Logger()
logger.log_time = True
db = DB(configuration.configuration,logger)
logger.setLogfile(configuration.configuration['log_file'])
osmdb = OSMDB.OSMDB(configuration.configuration, db, logger)

if cmdline.option('u') in ['host','hosts']:
    if cmdline.option('n') in [False,True]: cmdline.options['n'] = OSMDB.getDefaultRoute()
    ping_delays = osmdb.pingHosts(cmdline.option('n'))
    osmdb.updateHosts(ping_delays,cmdline.option('n'))

elif cmdline.option('e'):
    if cmdline.option('e') is True: helpAndExit('execute')
    osmdb.execOnHosts(cmdline.option('e'))

if cmdline.option('l') in ['host','hosts']:
    osmdb.listHosts()
elif cmdline.option('l') in ['update','updates']:
    osmdb.listHostUpdates()
